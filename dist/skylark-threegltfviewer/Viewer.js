/**
 * skylark-threegltfviewer - A version of threegltfviewer that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-threegltfviewer/
 * @license MIT
 */
define(["skylark-threejs","skylark-threejs-ex/utils/stats","skylark-threejs-ex/loaders/GLTFLoader","skylark-threejs-ex/loaders/DRACOLoader","skylark-threejs-ex/controls/OrbitControls","skylark-threejs-ex/loaders/RGBELoader","skylark-datgui","./threegltviewer","./environments","./vignettes"],function(t,s,i,a,n,r,o,h,d,l){"use strict";const m="[default]",p=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,u=["map","aoMap","emissiveMap","glossinessMap","metalnessMap","normalMap","roughnessMap","specularMap"],C={ASSET_GENERATOR:"assetgenerator"};t.Cache.enabled=!0;function x(e,t){e.traverse(e=>{if(!e.isMesh)return;(Array.isArray(e.material)?e.material:[e.material]).forEach(t)})}return class{constructor(e,i){this.el=e,this.options=i,this.lights=[],this.content=null,this.mixer=null,this.clips=[],this.gui=null,this.state={environment:i.preset===C.ASSET_GENERATOR?d.find(e=>"footprint-court"===e.id).name:d[1].name,background:!1,playbackSpeed:1,actionStates:{},camera:m,wireframe:!1,skeleton:!1,grid:!1,addLights:!0,exposure:1,textureEncoding:"sRGB",ambientIntensity:.3,ambientColor:16777215,directIntensity:.8*Math.PI,directColor:16777215,bgColor1:"#ffffff",bgColor2:"#353535"},this.prevTime=0,this.stats=new s,this.stats.dom.height="48px",[].forEach.call(this.stats.dom.children,e=>e.style.display=""),this.scene=new t.Scene;const a=i.preset===C.ASSET_GENERATOR?144/Math.PI:60;this.defaultCamera=new t.PerspectiveCamera(a,e.clientWidth/e.clientHeight,.01,1e3),this.activeCamera=this.defaultCamera,this.scene.add(this.defaultCamera),this.renderer=window.renderer=new t.WebGLRenderer({antialias:!0}),this.renderer.physicallyCorrectLights=!0,this.renderer.outputEncoding=t.sRGBEncoding,this.renderer.setClearColor(13421772),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(e.clientWidth,e.clientHeight),this.pmremGenerator=new t.PMREMGenerator(this.renderer),this.pmremGenerator.compileEquirectangularShader(),this.controls=new n(this.defaultCamera,this.renderer.domElement),this.controls.autoRotate=!1,this.controls.autoRotateSpeed=-10,this.controls.screenSpacePanning=!0,this.vignette=l.createBackground({aspect:this.defaultCamera.aspect,grainScale:p?0:.001,colors:[this.state.bgColor1,this.state.bgColor2]}),this.vignette.name="Vignette",this.vignette.renderOrder=-1,this.el.appendChild(this.renderer.domElement),this.cameraCtrl=null,this.cameraFolder=null,this.animFolder=null,this.animCtrls=[],this.morphFolder=null,this.morphCtrls=[],this.skeletonHelpers=[],this.gridHelper=null,this.axesHelper=null,this.addAxesHelper(),this.addGUI(),i.kiosk&&this.gui.close(),this.animate=this.animate.bind(this),requestAnimationFrame(this.animate),window.addEventListener("resize",this.resize.bind(this),!1)}animate(e){requestAnimationFrame(this.animate);const t=(e-this.prevTime)/1e3;this.controls.update(),this.stats.update(),this.mixer&&this.mixer.update(t),this.render(),this.prevTime=e}render(){this.renderer.render(this.scene,this.activeCamera),this.state.grid&&(this.axesCamera.position.copy(this.defaultCamera.position),this.axesCamera.lookAt(this.axesScene.position),this.axesRenderer.render(this.axesScene,this.axesCamera))}resize(){const{clientHeight:e,clientWidth:t}=this.el.parentElement;this.defaultCamera.aspect=t/e,this.defaultCamera.updateProjectionMatrix(),this.vignette.style({aspect:this.defaultCamera.aspect}),this.renderer.setSize(t,e),this.axesCamera.aspect=this.axesDiv.clientWidth/this.axesDiv.clientHeight,this.axesCamera.updateProjectionMatrix(),this.axesRenderer.setSize(this.axesDiv.clientWidth,this.axesDiv.clientHeight)}load(e,s,i){const a=t.LoaderUtils.extractUrlBase(e);return new Promise((n,r)=>{const o=new t.LoadingManager;o.setURLModifier((e,t)=>{const n=s+decodeURI(e).replace(a,"").replace(/^(\.?\/)/,"");if(i.has(n)){const e=i.get(n),t=URL.createObjectURL(e);return l.push(t),t}return(t||"")+e});const h=new b.GLTFLoader(o);h.setCrossOrigin("anonymous");const d=new c.DRACOLoader;d.setDecoderPath("assets/draco/"),h.setDRACOLoader(d);const l=[];h.load(e,e=>{const t=e.scene||e.scenes[0],s=e.animations||[];if(!t)throw new Error("This model contains no scene, and cannot be viewed here. However, it may contain individual 3D resources.");this.setContent(t,s),l.forEach(URL.revokeObjectURL),n(e)},void 0,r)})}setContent(e,s){this.clear();const i=(new t.Box3).setFromObject(e),a=i.getSize(new t.Vector3).length(),n=i.getCenter(new t.Vector3);this.controls.reset(),e.position.x+=e.position.x-n.x,e.position.y+=e.position.y-n.y,e.position.z+=e.position.z-n.z,this.controls.maxDistance=10*a,this.defaultCamera.near=a/100,this.defaultCamera.far=100*a,this.defaultCamera.updateProjectionMatrix(),this.options.cameraPosition?(this.defaultCamera.position.fromArray(this.options.cameraPosition),this.defaultCamera.lookAt(new t.Vector3)):(this.defaultCamera.position.copy(n),this.defaultCamera.position.x+=a/2,this.defaultCamera.position.y+=a/5,this.defaultCamera.position.z+=a/2,this.defaultCamera.lookAt(n)),this.setCamera(m),this.axesCamera.position.copy(this.defaultCamera.position),this.axesCamera.lookAt(this.axesScene.position),this.axesCamera.near=a/100,this.axesCamera.far=100*a,this.axesCamera.updateProjectionMatrix(),this.axesCorner.scale.set(a,a,a),this.controls.saveState(),this.scene.add(e),this.content=e,this.state.addLights=!0,this.content.traverse(e=>{e.isLight?this.state.addLights=!1:e.isMesh&&(e.material.depthWrite=!e.material.transparent)}),this.setClips(s),this.updateLights(),this.updateGUI(),this.updateEnvironment(),this.updateTextureEncoding(),this.updateDisplay(),window.content=this.content,console.info("[glTF Viewer] THREE.Scene exported as `window.content`."),this.printGraph(this.content)}printGraph(e){console.group(" <"+e.type+"> "+e.name),e.children.forEach(e=>this.printGraph(e)),console.groupEnd()}setClips(e){this.mixer&&(this.mixer.stopAllAction(),this.mixer.uncacheRoot(this.mixer.getRoot()),this.mixer=null),this.clips=e,e.length&&(this.mixer=new t.AnimationMixer(this.content))}playAllClips(){this.clips.forEach(e=>{this.mixer.clipAction(e).reset().play(),this.state.actionStates[e.name]=!0})}setCamera(e){e===m?(this.controls.enabled=!0,this.activeCamera=this.defaultCamera):(this.controls.enabled=!1,this.content.traverse(t=>{t.isCamera&&t.name===e&&(this.activeCamera=t)}))}updateTextureEncoding(){const e="sRGB"===this.state.textureEncoding?t.sRGBEncoding:t.LinearEncoding;x(this.content,t=>{t.map&&(t.map.encoding=e),t.emissiveMap&&(t.emissiveMap.encoding=e),(t.map||t.emissiveMap)&&(t.needsUpdate=!0)})}updateLights(){const e=this.state,t=this.lights;e.addLights&&!t.length?this.addLights():!e.addLights&&t.length&&this.removeLights(),this.renderer.toneMappingExposure=e.exposure,2===t.length&&(t[0].intensity=e.ambientIntensity,t[0].color.setHex(e.ambientColor),t[1].intensity=e.directIntensity,t[1].color.setHex(e.directColor))}addLights(){const e=this.state;if(this.options.preset===C.ASSET_GENERATOR){const e=new t.HemisphereLight;return e.name="hemi_light",this.scene.add(e),void this.lights.push(e)}const s=new t.AmbientLight(e.ambientColor,e.ambientIntensity);s.name="ambient_light",this.defaultCamera.add(s);const i=new t.DirectionalLight(e.directColor,e.directIntensity);i.position.set(.5,0,.866),i.name="main_light",this.defaultCamera.add(i),this.lights.push(s,i)}removeLights(){this.lights.forEach(e=>e.parent.remove(e)),this.lights.length=0}updateEnvironment(){const e=g.environments.filter(e=>e.name===this.state.environment)[0];this.getCubeMapTexture(e).then(({envMap:e})=>{e&&this.state.background||this.activeCamera!==this.defaultCamera?this.scene.remove(this.vignette):this.scene.add(this.vignette),this.scene.environment=e,this.scene.background=this.state.background?e:null})}getCubeMapTexture(s){const{path:i}=s;return i?new Promise((s,a)=>{(new e.RGBELoader).setDataType(t.UnsignedByteType).load(i,e=>{const t=this.pmremGenerator.fromEquirectangular(e).texture;this.pmremGenerator.dispose(),s({envMap:t})},void 0,a)}):Promise.resolve({envMap:null})}updateDisplay(){this.skeletonHelpers.length&&this.skeletonHelpers.forEach(e=>this.scene.remove(e)),x(this.content,e=>{e.wireframe=this.state.wireframe}),this.content.traverse(e=>{if(e.isMesh&&e.skeleton&&this.state.skeleton){const s=new t.SkeletonHelper(e.skeleton.bones[0].parent);s.material.linewidth=3,this.scene.add(s),this.skeletonHelpers.push(s)}}),this.state.grid!==Boolean(this.gridHelper)&&(this.state.grid?(this.gridHelper=new t.GridHelper,this.axesHelper=new t.AxesHelper,this.axesHelper.renderOrder=999,this.axesHelper.onBeforeRender=(e=>e.clearDepth()),this.scene.add(this.gridHelper),this.scene.add(this.axesHelper)):(this.scene.remove(this.gridHelper),this.scene.remove(this.axesHelper),this.gridHelper=null,this.axesHelper=null,this.axesRenderer.clear()))}updateBackground(){this.vignette.style({colors:[this.state.bgColor1,this.state.bgColor2]})}addAxesHelper(){this.axesDiv=document.createElement("div"),this.el.appendChild(this.axesDiv),this.axesDiv.classList.add("axes");const{clientWidth:e,clientHeight:s}=this.axesDiv;this.axesScene=new t.Scene,this.axesCamera=new t.PerspectiveCamera(50,e/s,.1,10),this.axesScene.add(this.axesCamera),this.axesRenderer=new t.WebGLRenderer({alpha:!0}),this.axesRenderer.setPixelRatio(window.devicePixelRatio),this.axesRenderer.setSize(this.axesDiv.clientWidth,this.axesDiv.clientHeight),this.axesCamera.up=this.defaultCamera.up,this.axesCorner=new t.AxesHelper(5),this.axesScene.add(this.axesCorner),this.axesDiv.appendChild(this.axesRenderer.domElement)}addGUI(){const e=this.gui=new o({autoPlace:!1,width:260,hideable:!0}),s=e.addFolder("Display");s.add(this.state,"background").onChange(()=>this.updateEnvironment()),s.add(this.state,"wireframe").onChange(()=>this.updateDisplay()),s.add(this.state,"skeleton").onChange(()=>this.updateDisplay()),s.add(this.state,"grid").onChange(()=>this.updateDisplay()),s.add(this.controls,"autoRotate"),s.add(this.controls,"screenSpacePanning");const i=s.addColor(this.state,"bgColor1"),a=s.addColor(this.state,"bgColor2");i.onChange(()=>this.updateBackground()),a.onChange(()=>this.updateBackground());const n=e.addFolder("Lighting");n.add(this.state,"textureEncoding",["sRGB","Linear"]).onChange(()=>this.updateTextureEncoding()),n.add(this.renderer,"outputEncoding",{sRGB:t.sRGBEncoding,Linear:t.LinearEncoding}).onChange(()=>{this.renderer.outputEncoding=Number(this.renderer.outputEncoding),x(this.content,e=>{e.needsUpdate=!0})}),n.add(this.state,"environment",g.environments.map(e=>e.name)).onChange(()=>this.updateEnvironment()),[n.add(this.state,"exposure",0,2),n.add(this.state,"addLights").listen(),n.add(this.state,"ambientIntensity",0,2),n.addColor(this.state,"ambientColor"),n.add(this.state,"directIntensity",0,4),n.addColor(this.state,"directColor")].forEach(e=>e.onChange(()=>this.updateLights())),this.animFolder=e.addFolder("Animation"),this.animFolder.domElement.style.display="none",this.animFolder.add(this.state,"playbackSpeed",0,1).onChange(e=>{this.mixer&&(this.mixer.timeScale=e)}),this.animFolder.add({playAll:()=>this.playAllClips()},"playAll"),this.morphFolder=e.addFolder("Morph Targets"),this.morphFolder.domElement.style.display="none",this.cameraFolder=e.addFolder("Cameras"),this.cameraFolder.domElement.style.display="none";const r=e.addFolder("Performance"),h=document.createElement("li");this.stats.dom.style.position="static",h.appendChild(this.stats.dom),h.classList.add("gui-stats"),r.__ul.appendChild(h);const d=document.createElement("div");this.el.appendChild(d),d.classList.add("gui-wrap"),d.appendChild(e.domElement),e.open()}updateGUI(){this.cameraFolder.domElement.style.display="none",this.morphCtrls.forEach(e=>e.remove()),this.morphCtrls.length=0,this.morphFolder.domElement.style.display="none",this.animCtrls.forEach(e=>e.remove()),this.animCtrls.length=0,this.animFolder.domElement.style.display="none";const e=[],t=[];if(this.content.traverse(s=>{s.isMesh&&s.morphTargetInfluences&&t.push(s),s.isCamera&&(s.name=s.name||`VIEWER__camera_${e.length+1}`,e.push(s.name))}),e.length){this.cameraFolder.domElement.style.display="",this.cameraCtrl&&this.cameraCtrl.remove();const t=[m].concat(e);this.cameraCtrl=this.cameraFolder.add(this.state,"camera",t),this.cameraCtrl.onChange(e=>this.setCamera(e))}if(t.length&&(this.morphFolder.domElement.style.display="",t.forEach(e=>{if(e.morphTargetInfluences.length){const t=this.morphFolder.add({name:e.name||"Untitled"},"name");this.morphCtrls.push(t)}for(let t=0;t<e.morphTargetInfluences.length;t++){const s=this.morphFolder.add(e.morphTargetInfluences,t,0,1,.01).listen();Object.keys(e.morphTargetDictionary).forEach(i=>{i&&e.morphTargetDictionary[i]===t&&s.name(i)}),this.morphCtrls.push(s)}})),this.clips.length){this.animFolder.domElement.style.display="";const e=this.state.actionStates={};this.clips.forEach((t,s)=>{let i;0===s?(e[t.name]=!0,(i=this.mixer.clipAction(t)).play()):e[t.name]=!1;const a=this.animFolder.add(e,t.name).listen();a.onChange(e=>{(i=i||this.mixer.clipAction(t)).setEffectiveTimeScale(1),e?i.play():i.stop()}),this.animCtrls.push(a)})}}clear(){this.content&&(this.scene.remove(this.content),this.content.traverse(e=>{e.isMesh&&e.geometry.dispose()}),x(this.content,e=>{u.forEach(t=>{e[t]&&e[t].dispose()})}))}}});
//# sourceMappingURL=sourcemaps/Viewer.js.map
