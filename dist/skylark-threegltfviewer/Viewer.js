/**
 * skylark-threegltfviewer - A version of threegltfviewer that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-threegltfviewer/
 * @license MIT
 */
define(["skylark-threejs","skylark-threejs-ex/utils/stats","skylark-threejs-ex/loaders/GLTFLoader","skylark-threejs-ex/loaders/DRACOLoader","skylark-threejs-ex/controls/OrbitControls","skylark-threejs-ex/loaders/RGBELoader","skylark-datgui","./threegltviewer","./environments","./vignettes"],function(e,t,s,i,a,n,r,o,h,d){"use strict";const l="[default]",c=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,m=["map","aoMap","emissiveMap","glossinessMap","metalnessMap","normalMap","roughnessMap","specularMap"],p={ASSET_GENERATOR:"assetgenerator"};e.Cache.enabled=!0;function g(e,t){e.traverse(e=>{if(!e.isMesh)return;(Array.isArray(e.material)?e.material:[e.material]).forEach(t)})}return o.Viewer=class{constructor(s,i){this.el=s,this.options=i,this.lights=[],this.content=null,this.mixer=null,this.clips=[],this.gui=null,this.state={environment:i.preset===p.ASSET_GENERATOR?h.find(e=>"footprint-court"===e.id).name:h[1].name,background:!1,playbackSpeed:1,actionStates:{},camera:l,wireframe:!1,skeleton:!1,grid:!1,addLights:!0,exposure:1,textureEncoding:"sRGB",ambientIntensity:.3,ambientColor:16777215,directIntensity:.8*Math.PI,directColor:16777215,bgColor1:"#ffffff",bgColor2:"#353535"},this.prevTime=0,this.stats=new t,this.stats.dom.height="48px",[].forEach.call(this.stats.dom.children,e=>e.style.display=""),this.scene=new e.Scene;const n=i.preset===p.ASSET_GENERATOR?144/Math.PI:60;this.defaultCamera=new e.PerspectiveCamera(n,s.clientWidth/s.clientHeight,.01,1e3),this.activeCamera=this.defaultCamera,this.scene.add(this.defaultCamera),this.renderer=window.renderer=new e.WebGLRenderer({antialias:!0}),this.renderer.physicallyCorrectLights=!0,this.renderer.outputEncoding=e.sRGBEncoding,this.renderer.setClearColor(13421772),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(s.clientWidth,s.clientHeight),this.pmremGenerator=new e.PMREMGenerator(this.renderer),this.pmremGenerator.compileEquirectangularShader(),this.controls=new a(this.defaultCamera,this.renderer.domElement),this.controls.autoRotate=!1,this.controls.autoRotateSpeed=-10,this.controls.screenSpacePanning=!0,this.vignette=d.createBackground({aspect:this.defaultCamera.aspect,grainScale:c?0:.001,colors:[this.state.bgColor1,this.state.bgColor2]}),this.vignette.name="Vignette",this.vignette.renderOrder=-1,this.el.appendChild(this.renderer.domElement),this.cameraCtrl=null,this.cameraFolder=null,this.animFolder=null,this.animCtrls=[],this.morphFolder=null,this.morphCtrls=[],this.skeletonHelpers=[],this.gridHelper=null,this.axesHelper=null,this.addAxesHelper(),this.addGUI(),i.kiosk&&this.gui.close(),this.animate=this.animate.bind(this),requestAnimationFrame(this.animate),window.addEventListener("resize",this.resize.bind(this),!1)}animate(e){requestAnimationFrame(this.animate);const t=(e-this.prevTime)/1e3;this.controls.update(),this.stats.update(),this.mixer&&this.mixer.update(t),this.render(),this.prevTime=e}render(){this.renderer.render(this.scene,this.activeCamera),this.state.grid&&(this.axesCamera.position.copy(this.defaultCamera.position),this.axesCamera.lookAt(this.axesScene.position),this.axesRenderer.render(this.axesScene,this.axesCamera))}resize(){const{clientHeight:e,clientWidth:t}=this.el.parentElement;this.defaultCamera.aspect=t/e,this.defaultCamera.updateProjectionMatrix(),this.vignette.style({aspect:this.defaultCamera.aspect}),this.renderer.setSize(t,e),this.axesCamera.aspect=this.axesDiv.clientWidth/this.axesDiv.clientHeight,this.axesCamera.updateProjectionMatrix(),this.axesRenderer.setSize(this.axesDiv.clientWidth,this.axesDiv.clientHeight)}load(t,a,n){const r=e.LoaderUtils.extractUrlBase(t);return new Promise((o,h)=>{const d=new e.LoadingManager;d.setURLModifier((e,t)=>{const s=a+decodeURI(e).replace(r,"").replace(/^(\.?\/)/,"");if(n.has(s)){const e=n.get(s),t=URL.createObjectURL(e);return m.push(t),t}return(t||"")+e});const l=new s(d);l.setCrossOrigin("anonymous");const c=new i;c.setDecoderPath("assets/draco/"),l.setDRACOLoader(c);const m=[];l.load(t,e=>{const t=e.scene||e.scenes[0],s=e.animations||[];if(!t)throw new Error("This model contains no scene, and cannot be viewed here. However, it may contain individual 3D resources.");this.setContent(t,s),m.forEach(URL.revokeObjectURL),o(e)},void 0,h)})}setContent(t,s){this.clear();const i=(new e.Box3).setFromObject(t),a=i.getSize(new e.Vector3).length(),n=i.getCenter(new e.Vector3);this.controls.reset(),t.position.x+=t.position.x-n.x,t.position.y+=t.position.y-n.y,t.position.z+=t.position.z-n.z,this.controls.maxDistance=10*a,this.defaultCamera.near=a/100,this.defaultCamera.far=100*a,this.defaultCamera.updateProjectionMatrix(),this.options.cameraPosition?(this.defaultCamera.position.fromArray(this.options.cameraPosition),this.defaultCamera.lookAt(new e.Vector3)):(this.defaultCamera.position.copy(n),this.defaultCamera.position.x+=a/2,this.defaultCamera.position.y+=a/5,this.defaultCamera.position.z+=a/2,this.defaultCamera.lookAt(n)),this.setCamera(l),this.axesCamera.position.copy(this.defaultCamera.position),this.axesCamera.lookAt(this.axesScene.position),this.axesCamera.near=a/100,this.axesCamera.far=100*a,this.axesCamera.updateProjectionMatrix(),this.axesCorner.scale.set(a,a,a),this.controls.saveState(),this.scene.add(t),this.content=t,this.state.addLights=!0,this.content.traverse(e=>{e.isLight?this.state.addLights=!1:e.isMesh&&(e.material.depthWrite=!e.material.transparent)}),this.setClips(s),this.updateLights(),this.updateGUI(),this.updateEnvironment(),this.updateTextureEncoding(),this.updateDisplay(),window.content=this.content,console.info("[glTF Viewer] THREE.Scene exported as `window.content`."),this.printGraph(this.content)}printGraph(e){console.group(" <"+e.type+"> "+e.name),e.children.forEach(e=>this.printGraph(e)),console.groupEnd()}setClips(t){this.mixer&&(this.mixer.stopAllAction(),this.mixer.uncacheRoot(this.mixer.getRoot()),this.mixer=null),this.clips=t,t.length&&(this.mixer=new e.AnimationMixer(this.content))}playAllClips(){this.clips.forEach(e=>{this.mixer.clipAction(e).reset().play(),this.state.actionStates[e.name]=!0})}setCamera(e){e===l?(this.controls.enabled=!0,this.activeCamera=this.defaultCamera):(this.controls.enabled=!1,this.content.traverse(t=>{t.isCamera&&t.name===e&&(this.activeCamera=t)}))}updateTextureEncoding(){const t="sRGB"===this.state.textureEncoding?e.sRGBEncoding:e.LinearEncoding;g(this.content,e=>{e.map&&(e.map.encoding=t),e.emissiveMap&&(e.emissiveMap.encoding=t),(e.map||e.emissiveMap)&&(e.needsUpdate=!0)})}updateLights(){const e=this.state,t=this.lights;e.addLights&&!t.length?this.addLights():!e.addLights&&t.length&&this.removeLights(),this.renderer.toneMappingExposure=e.exposure,2===t.length&&(t[0].intensity=e.ambientIntensity,t[0].color.setHex(e.ambientColor),t[1].intensity=e.directIntensity,t[1].color.setHex(e.directColor))}addLights(){const t=this.state;if(this.options.preset===p.ASSET_GENERATOR){const t=new e.HemisphereLight;return t.name="hemi_light",this.scene.add(t),void this.lights.push(t)}const s=new e.AmbientLight(t.ambientColor,t.ambientIntensity);s.name="ambient_light",this.defaultCamera.add(s);const i=new e.DirectionalLight(t.directColor,t.directIntensity);i.position.set(.5,0,.866),i.name="main_light",this.defaultCamera.add(i),this.lights.push(s,i)}removeLights(){this.lights.forEach(e=>e.parent.remove(e)),this.lights.length=0}updateEnvironment(){const e=h.filter(e=>e.name===this.state.environment)[0];this.getCubeMapTexture(e).then(({envMap:e})=>{e&&this.state.background||this.activeCamera!==this.defaultCamera?this.scene.remove(this.vignette):this.scene.add(this.vignette),this.scene.environment=e,this.scene.background=this.state.background?e:null})}getCubeMapTexture(t){const{path:s}=t;return s?new Promise((t,i)=>{(new n).setDataType(e.UnsignedByteType).load(s,e=>{const s=this.pmremGenerator.fromEquirectangular(e).texture;this.pmremGenerator.dispose(),t({envMap:s})},void 0,i)}):Promise.resolve({envMap:null})}updateDisplay(){this.skeletonHelpers.length&&this.skeletonHelpers.forEach(e=>this.scene.remove(e)),g(this.content,e=>{e.wireframe=this.state.wireframe}),this.content.traverse(t=>{if(t.isMesh&&t.skeleton&&this.state.skeleton){const s=new e.SkeletonHelper(t.skeleton.bones[0].parent);s.material.linewidth=3,this.scene.add(s),this.skeletonHelpers.push(s)}}),this.state.grid!==Boolean(this.gridHelper)&&(this.state.grid?(this.gridHelper=new e.GridHelper,this.axesHelper=new e.AxesHelper,this.axesHelper.renderOrder=999,this.axesHelper.onBeforeRender=(e=>e.clearDepth()),this.scene.add(this.gridHelper),this.scene.add(this.axesHelper)):(this.scene.remove(this.gridHelper),this.scene.remove(this.axesHelper),this.gridHelper=null,this.axesHelper=null,this.axesRenderer.clear()))}updateBackground(){this.vignette.style({colors:[this.state.bgColor1,this.state.bgColor2]})}addAxesHelper(){this.axesDiv=document.createElement("div"),this.el.appendChild(this.axesDiv),this.axesDiv.classList.add("axes");const{clientWidth:t,clientHeight:s}=this.axesDiv;this.axesScene=new e.Scene,this.axesCamera=new e.PerspectiveCamera(50,t/s,.1,10),this.axesScene.add(this.axesCamera),this.axesRenderer=new e.WebGLRenderer({alpha:!0}),this.axesRenderer.setPixelRatio(window.devicePixelRatio),this.axesRenderer.setSize(this.axesDiv.clientWidth,this.axesDiv.clientHeight),this.axesCamera.up=this.defaultCamera.up,this.axesCorner=new e.AxesHelper(5),this.axesScene.add(this.axesCorner),this.axesDiv.appendChild(this.axesRenderer.domElement)}addGUI(){const t=this.gui=new r.GUI({autoPlace:!1,width:260,hideable:!0}),s=t.addFolder("Display");s.add(this.state,"background").onChange(()=>this.updateEnvironment()),s.add(this.state,"wireframe").onChange(()=>this.updateDisplay()),s.add(this.state,"skeleton").onChange(()=>this.updateDisplay()),s.add(this.state,"grid").onChange(()=>this.updateDisplay()),s.add(this.controls,"autoRotate"),s.add(this.controls,"screenSpacePanning");const i=s.addColor(this.state,"bgColor1"),a=s.addColor(this.state,"bgColor2");i.onChange(()=>this.updateBackground()),a.onChange(()=>this.updateBackground());const n=t.addFolder("Lighting");n.add(this.state,"textureEncoding",["sRGB","Linear"]).onChange(()=>this.updateTextureEncoding()),n.add(this.renderer,"outputEncoding",{sRGB:e.sRGBEncoding,Linear:e.LinearEncoding}).onChange(()=>{this.renderer.outputEncoding=Number(this.renderer.outputEncoding),g(this.content,e=>{e.needsUpdate=!0})}),n.add(this.state,"environment",h.map(e=>e.name)).onChange(()=>this.updateEnvironment()),[n.add(this.state,"exposure",0,2),n.add(this.state,"addLights").listen(),n.add(this.state,"ambientIntensity",0,2),n.addColor(this.state,"ambientColor"),n.add(this.state,"directIntensity",0,4),n.addColor(this.state,"directColor")].forEach(e=>e.onChange(()=>this.updateLights())),this.animFolder=t.addFolder("Animation"),this.animFolder.domElement.style.display="none",this.animFolder.add(this.state,"playbackSpeed",0,1).onChange(e=>{this.mixer&&(this.mixer.timeScale=e)}),this.animFolder.add({playAll:()=>this.playAllClips()},"playAll"),this.morphFolder=t.addFolder("Morph Targets"),this.morphFolder.domElement.style.display="none",this.cameraFolder=t.addFolder("Cameras"),this.cameraFolder.domElement.style.display="none";const o=t.addFolder("Performance"),d=document.createElement("li");this.stats.dom.style.position="static",d.appendChild(this.stats.dom),d.classList.add("gui-stats"),o.__ul.appendChild(d);const l=document.createElement("div");this.el.appendChild(l),l.classList.add("gui-wrap"),l.appendChild(t.domElement),t.open()}updateGUI(){this.cameraFolder.domElement.style.display="none",this.morphCtrls.forEach(e=>e.remove()),this.morphCtrls.length=0,this.morphFolder.domElement.style.display="none",this.animCtrls.forEach(e=>e.remove()),this.animCtrls.length=0,this.animFolder.domElement.style.display="none";const e=[],t=[];if(this.content.traverse(s=>{s.isMesh&&s.morphTargetInfluences&&t.push(s),s.isCamera&&(s.name=s.name||`VIEWER__camera_${e.length+1}`,e.push(s.name))}),e.length){this.cameraFolder.domElement.style.display="",this.cameraCtrl&&this.cameraCtrl.remove();const t=[l].concat(e);this.cameraCtrl=this.cameraFolder.add(this.state,"camera",t),this.cameraCtrl.onChange(e=>this.setCamera(e))}if(t.length&&(this.morphFolder.domElement.style.display="",t.forEach(e=>{if(e.morphTargetInfluences.length){const t=this.morphFolder.add({name:e.name||"Untitled"},"name");this.morphCtrls.push(t)}for(let t=0;t<e.morphTargetInfluences.length;t++){const s=this.morphFolder.add(e.morphTargetInfluences,t,0,1,.01).listen();Object.keys(e.morphTargetDictionary).forEach(i=>{i&&e.morphTargetDictionary[i]===t&&s.name(i)}),this.morphCtrls.push(s)}})),this.clips.length){this.animFolder.domElement.style.display="";const e=this.state.actionStates={};this.clips.forEach((t,s)=>{let i;0===s?(e[t.name]=!0,(i=this.mixer.clipAction(t)).play()):e[t.name]=!1;const a=this.animFolder.add(e,t.name).listen();a.onChange(e=>{(i=i||this.mixer.clipAction(t)).setEffectiveTimeScale(1),e?i.play():i.stop()}),this.animCtrls.push(a)})}}clear(){this.content&&(this.scene.remove(this.content),this.content.traverse(e=>{e.isMesh&&e.geometry.dispose()}),g(this.content,e=>{m.forEach(t=>{e[t]&&e[t].dispose()})}))}}});
//# sourceMappingURL=sourcemaps/Viewer.js.map
